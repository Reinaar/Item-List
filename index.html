<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Items Database</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
            --card-bg: #ffffff;
            --input-bg: #ffffff;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
            --card-bg: #1e293b;
            --input-bg: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Header */
        .header {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .header-title h1 {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-title p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 2rem;
            padding: 0.5rem;
            cursor: pointer;
            display: flex;
            gap: 0.5rem;
            transition: all 0.3s;
        }

        .theme-option {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .theme-option.active {
            background: var(--primary);
            transform: scale(1.1);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            padding: 1rem;
            border-radius: 0.75rem;
            color: white;
            text-align: center;
        }

        .stat-card .number {
            font-size: 1.75rem;
            font-weight: 800;
            line-height: 1;
        }

        .stat-card .label {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }

        /* Controls */
        .controls {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px var(--shadow);
            border: 1px solid var(--border);
        }

        .search-box {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-box input {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 3rem;
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            font-size: 0.95rem;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.1rem;
        }

        .categories {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }

        .categories::-webkit-scrollbar {
            height: 6px;
        }

        .categories::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        .categories::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .category-pill {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: 2rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.85rem;
            white-space: nowrap;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .category-pill:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .category-pill.active {
            background: var(--primary);
            color: white;
        }

        .category-pill .count {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.125rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .filter-select {
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            font-size: 0.9rem;
            background: var(--input-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            justify-content: center;
            min-width: fit-content;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
        }

        .view-toggle {
            display: flex;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            padding: 0.25rem;
            flex: 1;
        }

        .view-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.3s;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .view-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Content */
        .content {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px var(--shadow);
            border: 1px solid var(--border);
            min-height: 400px;
        }

        /* Grid View */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(100%, 320px), 1fr));
            gap: 1rem;
        }

        .item-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.25rem;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            user-select: none;
        }

        .item-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px -5px var(--shadow);
        }

        .item-card:active {
            transform: translateY(-1px);
        }

        .copy-indicator {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: var(--success);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s;
            pointer-events: none;
            z-index: 100;
        }

        .copy-indicator.show {
            opacity: 1;
            transform: scale(1);
        }

        .click-hint {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .click-hint code {
            background: var(--input-bg);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-family: monospace;
            color: var(--primary);
        }

        .item-header {
            margin-bottom: 1rem;
        }

        .item-name {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .item-id {
            display: inline-block;
            font-size: 0.75rem;
            color: white;
            background: var(--primary);
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-family: monospace;
        }

        .item-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .badge {
            padding: 0.375rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-upgrade {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .badge-unlimited {
            background: #dcfce7;
            color: #166534;
        }

        .badge-limited {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-not-upgradable {
            background: #fee2e2;
            color: #991b1b;
        }

        .item-detail {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .item-detail strong {
            color: var(--text-primary);
            display: block;
            margin-bottom: 0.25rem;
        }

        .item-detail code {
            background: var(--input-bg);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            word-break: break-all;
            display: block;
            margin-top: 0.25rem;
        }

        /* Table View */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
        }

        .items-table thead th {
            padding: 0.875rem;
            text-align: left;
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            background: var(--bg-tertiary);
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .items-table tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .items-table tbody tr:hover {
            background: var(--bg-tertiary);
        }

        .items-table tbody td {
            padding: 0.875rem;
            font-size: 0.9rem;
        }

        /* Loading & Empty States */
        .loader {
            text-align: center;
            padding: 3rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 1rem;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--text-secondary);
        }

        .load-more {
            margin-top: 1.5rem;
            text-align: center;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .container {
                padding: 0.75rem;
            }

            .header, .controls, .content {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .header-top {
                flex-direction: column;
                align-items: flex-start;
            }

            .theme-toggle {
                align-self: flex-end;
            }

            .stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
            }

            .stat-card {
                padding: 0.75rem 0.5rem;
            }

            .stat-card .number {
                font-size: 1.5rem;
            }

            .stat-card .label {
                font-size: 0.7rem;
            }

            .filters {
                grid-template-columns: 1fr;
            }

            .actions {
                flex-direction: column;
            }

            .btn {
                flex: 1;
                width: 100%;
            }

            .view-toggle {
                width: 100%;
            }

            .items-grid {
                grid-template-columns: 1fr;
            }

            .items-table {
                font-size: 0.8rem;
            }

            .items-table thead th,
            .items-table tbody td {
                padding: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .header-title h1 {
                font-size: 1.5rem;
            }

            .categories {
                gap: 0.375rem;
            }

            .category-pill {
                padding: 0.375rem 0.75rem;
                font-size: 0.8rem;
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            box-shadow: 0 20px 25px -5px var(--shadow);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 1000;
            opacity: 0;
            transform: translateY(100px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast-content {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .toast-title {
            font-weight: 700;
            color: var(--text-primary);
        }

        .toast-message {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-family: monospace;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .quick-btn {
            flex: 1;
            padding: 0.5rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            color: var(--text-primary);
        }

        .quick-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .quick-btn:active {
            transform: scale(0.95);
        }

        /* Smooth transitions */
        * {
            transition-property: background-color, border-color, color, fill, stroke, box-shadow;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        @media (max-width: 768px) {
            .toast {
                bottom: 1rem;
                right: 1rem;
                left: 1rem;
                max-width: calc(100% - 2rem);
            }
        }
    </style>
</head>
<body data-theme="light">
    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <div class="toast-icon">üìã</div>
        <div class="toast-content">
            <div class="toast-title">Copied to clipboard!</div>
            <div class="toast-message" id="toastMessage"></div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <div class="header-title">
                    <h1>üéÆ Item List</h1>
                    <p>Complete items catalog</p>
                </div>
                <div class="theme-toggle" onclick="toggleTheme()">
                    <div class="theme-option" data-theme="light">‚òÄÔ∏è</div>
                    <div class="theme-option" data-theme="dark">üåô</div>
                </div>
            </div>
            <div class="stats">
                <div class="stat-card">
                    <div class="number" id="totalItems">0</div>
                    <div class="label">Total Items</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--secondary), #be185d);">
                    <div class="number" id="showingItems">0</div>
                    <div class="label">Showing</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--success), #059669);">
                    <div class="number" id="totalCategories">0</div>
                    <div class="label">Categories</div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" placeholder="Search by name, ID, or description...">
            </div>

            <div class="categories" id="categoryPills"></div>

            <div class="filters">
                <select id="upgradeFilter" class="filter-select">
                    <option value="">All Upgrades</option>
                </select>
                <select id="rarityFilter" class="filter-select">
                    <option value="">All Rarities</option>
                    <option value="unlimited">Unlimited</option>
                    <option value="limited">Limited</option>
                    <option value="not_upgradable">Not Upgradable</option>
                </select>
                <select id="sortFilter" class="filter-select">
                    <option value="name-asc">Name (A-Z)</option>
                    <option value="name-desc">Name (Z-A)</option>
                    <option value="id-asc">ID (Low to High)</option>
                    <option value="id-desc">ID (High to Low)</option>
                </select>
            </div>

            <div class="actions">
                <div class="view-toggle">
                    <button class="view-btn active" onclick="setView('grid')" data-view="grid">
                        üìä Grid
                    </button>
                    <button class="view-btn" onclick="setView('table')" data-view="table">
                        üìã Table
                    </button>
                </div>
                <button class="btn btn-secondary" onclick="resetFilters()">
                    üîÑ Reset
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="content" id="content">
            <div class="loader">
                <div class="spinner"></div>
                <div>Loading items database...</div>
            </div>
        </div>
    </div>

    <script>
        let allItems = {};
        let currentCategory = 'all';
        let currentView = 'grid';
        let filteredItems = [];
        let renderTimer = null;

        const categories = [
            'Pandora', 'Naomi', 'Kai', 'CHIP', 'Knox', 'Simon', 
            'Sophitia', 'Amelia', 'Sharkill', 'Accessories', 
            'Melee', 'Rifle', 'Shotgun', 'Sniper', 'Gatling', 
            'Bazooka', 'Grenade', 'Other Items', 'Banned Items & Weapons'
        ];

        const COLUMN_MAPPINGS = {
            'Item ID': 'id', 'ItemID': 'id', 'ID': 'id',
            'Name': 'name', 'Item Name': 'name', 'ItemName': 'name',
            'Upgrades': 'upgrades', 'Upgrade': 'upgrades',
            'Item Name Option': 'type', 'Type': 'type', 'Rarity': 'type',
            'Item Name Time': 'meshFile',
            'Mesh File Name': 'description',
            'Mesh File': 'meshFile', 'MeshFile': 'meshFile',
            'Description': 'description', 'Desc': 'description'
        };

        // Theme Management
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeToggle(newTheme);
        }

        function updateThemeToggle(theme) {
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.toggle('active', opt.getAttribute('data-theme') === theme);
            });
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            updateThemeToggle(savedTheme);
        }

        // Data Loading
        async function loadData() {
            const promises = categories.map(async (category) => {
                try {
                    const response = await fetch(`./csv/${category}.csv`);
                    if (!response.ok) return;
                    const text = await response.text();
                    allItems[category] = parseCSV(text);
                } catch (error) {
                    console.error(`Error loading ${category}:`, error);
                }
            });

            await Promise.all(promises);

            if (Object.keys(allItems).length === 0) {
                showError();
                return;
            }

            renderCategoryPills();
            setupFilters();
            updateFilteredItems();
            updateStats();
            renderItems();
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const validLines = [];
            
            // Filter valid lines upfront
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) validLines.push(line);
            }
            
            if (validLines.length < 2) return [];

            const headers = parseCSVLine(validLines[0]);
            const columnMap = {};
            
            // Build column mapping once
            for (let i = 0; i < headers.length; i++) {
                const mappedField = COLUMN_MAPPINGS[headers[i].trim()];
                if (mappedField && !columnMap[mappedField]) {
                    columnMap[mappedField] = i;
                }
            }

            const items = [];
            const idIndex = columnMap.id;
            const nameIndex = columnMap.name;
            const upgradesIndex = columnMap.upgrades;
            const typeIndex = columnMap.type;
            const meshFileIndex = columnMap.meshFile;
            const descriptionIndex = columnMap.description;

            // Parse data rows with pre-computed indices
            for (let i = 1; i < validLines.length; i++) {
                const values = parseCSVLine(validLines[i]);
                const id = getValue(values, idIndex);
                const name = getValue(values, nameIndex);
                
                if (id && name) {
                    items.push({
                        id: id,
                        name: name,
                        upgrades: getValue(values, upgradesIndex) || 'None',
                        type: getValue(values, typeIndex) || 'Unknown',
                        meshFile: getValue(values, meshFileIndex),
                        description: getValue(values, descriptionIndex)
                    });
                }
            }
            
            return items;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function getValue(values, index) {
            return (index !== undefined && values[index]) ? values[index].trim() : '';
        }

        // UI Rendering
        function renderCategoryPills() {
            const container = document.getElementById('categoryPills');
            const total = Object.values(allItems).reduce((sum, items) => sum + items.length, 0);
            
            let html = `
                <div class="category-pill ${currentCategory === 'all' ? 'active' : ''}" onclick="filterByCategory('all')">
                    <span>All</span>
                    <span class="count">${total}</span>
                </div>
            `;
            
            Object.keys(allItems).forEach(cat => {
                html += `
                    <div class="category-pill ${currentCategory === cat ? 'active' : ''}" onclick="filterByCategory('${cat}')">
                        <span>${cat}</span>
                        <span class="count">${allItems[cat].length}</span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function filterByCategory(category) {
            currentCategory = category;
            renderCategoryPills();
            updateFilteredItems();
            renderItems();
        }

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-view') === view);
            });
            renderItems();
        }

        function updateFilteredItems() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const upgradeFilter = document.getElementById('upgradeFilter')?.value.toLowerCase() || '';
            const rarityFilter = document.getElementById('rarityFilter')?.value || '';
            const sortFilter = document.getElementById('sortFilter')?.value || 'name-asc';
            
            const categoriesToShow = currentCategory === 'all' ? Object.keys(allItems) : [currentCategory];
            filteredItems = [];

            const hasSearch = searchTerm.length > 0;
            const hasUpgradeFilter = upgradeFilter.length > 0;
            const hasRarityFilter = rarityFilter.length > 0;

            for (const category of categoriesToShow) {
                const items = allItems[category];
                if (!items) continue;
                
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    
                    // Early exit optimizations
                    if (hasSearch) {
                        const matchesSearch = 
                            item.name.toLowerCase().includes(searchTerm) ||
                            item.id.toLowerCase().includes(searchTerm) ||
                            item.description.toLowerCase().includes(searchTerm);
                        if (!matchesSearch) continue;
                    }

                    if (hasUpgradeFilter && !item.upgrades.toLowerCase().includes(upgradeFilter)) continue;

                    if (hasRarityFilter) {
                        const type = item.type.toLowerCase();
                        if (rarityFilter === 'unlimited' && !type.includes('unlimited')) continue;
                        if (rarityFilter === 'limited' && !(type.includes('limited') || type.includes('level'))) continue;
                        if (rarityFilter === 'not_upgradable' && !type.includes('not upgradable')) continue;
                    }

                    filteredItems.push({ ...item, category });
                }
            }

            // Optimized sorting
            if (sortFilter === 'name-asc') {
                filteredItems.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortFilter === 'name-desc') {
                filteredItems.sort((a, b) => b.name.localeCompare(a.name));
            } else if (sortFilter === 'id-asc') {
                filteredItems.sort((a, b) => parseInt(a.id) - parseInt(b.id));
            } else if (sortFilter === 'id-desc') {
                filteredItems.sort((a, b) => parseInt(b.id) - parseInt(a.id));
            }

            document.getElementById('showingItems').textContent = filteredItems.length.toLocaleString();
        }

        function scheduleRender() {
            if (renderTimer) {
                clearTimeout(renderTimer);
                cancelAnimationFrame(renderTimer);
            }
            
            renderTimer = setTimeout(() => {
                requestAnimationFrame(() => {
                    updateFilteredItems();
                    renderItems();
                });
            }, 250);
        }

        function renderItems() {
            const content = document.getElementById('content');

            if (filteredItems.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <h3>No items found</h3>
                        <p>Try adjusting your search or filters</p>
                    </div>
                `;
                return;
            }

            if (currentView === 'grid') {
                renderGridView(content);
            } else {
                renderTableView(content);
            }
        }

        // Copy Functions
        function copyGetItem(itemId, itemName, event) {
            event?.stopPropagation();
            const command = `/getitem ${itemId}`;
            copyToClipboard(command, itemName);
        }

        function copyItemId(itemId, event) {
            event?.stopPropagation();
            copyToClipboard(itemId, `ID: ${itemId}`);
        }

        async function copyToClipboard(text, displayText) {
            try {
                await navigator.clipboard.writeText(text);
                showToast(displayText || text);
            } catch (err) {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast(displayText || text);
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2500);
        }

        // Performance: Virtual Scrolling for Grid View
        function renderGridView(container) {
            const itemsPerBatch = 50;
            let renderedCount = 0;
            let isRendering = false;
            
            function renderBatch() {
                if (isRendering || renderedCount >= filteredItems.length) return;
                
                isRendering = true;
                const start = renderedCount;
                const end = Math.min(start + itemsPerBatch, filteredItems.length);
                const batchItems = filteredItems.slice(start, end);
                
                // Use DocumentFragment for better performance
                const fragment = document.createDocumentFragment();
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = batchItems.map(item => renderItemCard(item)).join('');
                
                while (tempDiv.firstChild) {
                    fragment.appendChild(tempDiv.firstChild);
                }
                
                if (renderedCount === 0) {
                    container.innerHTML = '<div class="items-grid"></div>';
                }
                
                const grid = container.querySelector('.items-grid');
                grid.appendChild(fragment);
                
                renderedCount = end;
                isRendering = false;
                
                // Add load more button if needed
                updateLoadMoreButton(container, end);
            }

            function updateLoadMoreButton(container, currentCount) {
                let loadMoreDiv = container.querySelector('.load-more');
                
                if (currentCount >= filteredItems.length) {
                    loadMoreDiv?.remove();
                    return;
                }
                
                if (!loadMoreDiv) {
                    loadMoreDiv = document.createElement('div');
                    loadMoreDiv.className = 'load-more';
                    container.appendChild(loadMoreDiv);
                }
                
                loadMoreDiv.innerHTML = `
                    <button class="btn btn-primary" onclick="window.loadMoreItems()">
                        Load More (${filteredItems.length - currentCount} remaining)
                    </button>
                `;
            }

            window.loadMoreItems = function() {
                renderBatch();
            };

            // Initial render
            renderBatch();
        }

        function renderTableView(container) {
            var skip = false;
            const visibleItems = filteredItems; // Show all items
            
            let html = `
                <div class="table-container">
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Upgrades</th>
                                <th>Category</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            visibleItems.forEach(item => {
            if(item.name.includes("????") || item.name.includes("BUGGED") || item.name.includes("Krymel")) { skip = true; return; };

                const rarityClass = getRarityClass(item.type);
                html += `
                    <tr onclick="copyGetItem('${escapeHtml(item.id)}', '${escapeHtml(item.name)}', event)" style="cursor: pointer;">
                        <td><span class="item-id">${escapeHtml(item.id)}</span></td>
                        <td><strong>${escapeHtml(item.name)}</strong></td>
                        <td><span class="badge ${rarityClass}">${escapeHtml(item.type)}</span></td>
                        <td>${item.upgrades !== 'None' ? `<span class="badge badge-upgrade">‚ö° ${escapeHtml(item.upgrades)}</span>` : '-'}</td>
                        <td>${item.category}</td>
                        <td>
                            <button class="quick-btn" onclick="copyGetItem('${escapeHtml(item.id)}', '${escapeHtml(item.name)}', event)" style="margin: 0;">
                                üìã Copy
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            if (!skip)
                container.innerHTML = html;
        }

        function renderItemCard(item) {
            if(item.name.includes("????") || item.name.includes("BUGGED") || item.name.includes("Krymel")) return;

            const rarityClass = getRarityClass(item.type);
            
            return `
                <div class="item-card" onclick="copyGetItem('${escapeHtml(item.id)}', '${escapeHtml(item.name)}', event)">
                    <div class="item-header">
                        <div class="item-name">${escapeHtml(item.name)}</div>
                        <span class="item-id">${escapeHtml(item.id)}</span>
                    </div>
                    
                    <div class="item-badges">
                        ${item.upgrades !== 'None' ? `<span class="badge badge-upgrade">‚ö° ${escapeHtml(item.upgrades)}</span>` : ''}
                        <span class="badge ${rarityClass}">${escapeHtml(item.type)}</span>
                    </div>
                    
                    ${item.meshFile ? `
                        <div class="item-detail">
                            <strong>üì¶ Mesh File</strong>
                            <code>${escapeHtml(item.meshFile)}</code>
                        </div>
                    ` : ''}
                    
                    ${item.description ? `
                        <div class="item-detail">
                            <strong>üìù Description</strong>
                            <div>${escapeHtml(item.description)}</div>
                        </div>
                    ` : ''}

                    <div class="quick-actions">
                        <button class="quick-btn" onclick="copyGetItem('${escapeHtml(item.id)}', '${escapeHtml(item.name)}', event)">
                            üìã /getitem ${escapeHtml(item.id)}
                        </button>
                        <button class="quick-btn" onclick="copyItemId('${escapeHtml(item.id)}', event)">
                            üî¢ ID Only
                        </button>
                    </div>
                </div>
            `;
        }

        function getRarityClass(type) {
            const t = type.toLowerCase();
            if (t.includes('unlimited')) return 'badge-unlimited';
            if (t.includes('not upgradable')) return 'badge-not-upgradable';
            return 'badge-limited';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function setupFilters() {
            const upgrades = new Set();
            Object.values(allItems).forEach(items => {
                items.forEach(item => {
                    if (item.upgrades && item.upgrades !== 'None') {
                        upgrades.add(item.upgrades);
                    }
                });
            });

            const upgradeFilter = document.getElementById('upgradeFilter');
            Array.from(upgrades).sort().forEach(upgrade => {
                const option = document.createElement('option');
                option.value = upgrade;
                option.textContent = upgrade;
                if (upgrade.includes("Accuracy") || upgrade.includes("Damage") || upgrade.includes("Range") || upgrade.includes("Rate") || upgrade.includes("Reload") || upgrade.includes("Ammo") || upgrade.includes("Speed") || upgrade.includes("HP+") || upgrade.includes("Bullets") || upgrade.includes("Projectile") || upgrade.includes("Radius")) {
                    upgradeFilter.appendChild(option);
                };
            });

            document.getElementById('searchInput').addEventListener('input', scheduleRender);
            document.getElementById('upgradeFilter').addEventListener('change', scheduleRender);
            document.getElementById('rarityFilter').addEventListener('change', scheduleRender);
            document.getElementById('sortFilter').addEventListener('change', scheduleRender);
        }

        function updateStats() {
            const total = Object.values(allItems).reduce((sum, items) => sum + items.length, 0);
            document.getElementById('totalItems').textContent = total.toLocaleString();
            document.getElementById('totalCategories').textContent = Object.keys(allItems).length;
            document.getElementById('showingItems').textContent = total.toLocaleString();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('upgradeFilter').value = '';
            document.getElementById('rarityFilter').value = '';
            document.getElementById('sortFilter').value = 'name-asc';
            currentCategory = 'all';
            renderCategoryPills();
            updateFilteredItems();
            renderItems();
        }

        function showError() {
            document.getElementById('content').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">‚ö†Ô∏è</div>
                    <h3>Could not load CSV files</h3>
                    <p>Make sure CSV files are in the ./csv/ directory</p>
                </div>
            `;
        }

        // Initialize
        loadTheme();
        loadData();
    </script>
</body>
</html>